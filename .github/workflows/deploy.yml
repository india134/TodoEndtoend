name: CD Pipeline - Deploy FastAPI Todo App

on:
  workflow_run:
    workflows: ["CD Pipeline - Build & Push Docker Image"]  # Must match the exact workflow name
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and deploy latest container
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üßπ Cleaning up any existing containers..."
            CONTAINER_ID=$(sudo docker ps -aq --filter "name=todo-fastapi")
            if [ -n "$CONTAINER_ID" ]; then
              echo "Stopping and removing existing 'todo-fastapi' container..."
              sudo docker stop $CONTAINER_ID || true
              sudo docker rm $CONTAINER_ID || true
            else
              echo "No old container found. Proceeding..."
            fi

            echo "üßº Removing dangling images to free space..."
            sudo docker image prune -f || true

            echo "üì¶ Pulling the latest Docker image..."
            sudo docker pull akashdocker134/todo-fastapi:latest

            echo "üöÄ Starting new container..."
            sudo docker run -d -p 8000:8000 --name todo-fastapi akashdocker134/todo-fastapi:latest

            echo "üîç Verifying container status..."
            sleep 5
            if sudo docker ps | grep -q "todo-fastapi"; then
              echo "‚úÖ Deployment successful! Container is running."
              sudo docker ps
            else
              echo "‚ùå Deployment failed ‚Äî container not running!"
              echo "Showing recent logs for debugging:"
              sudo docker logs todo-fastapi || true
              exit 1
            fi

