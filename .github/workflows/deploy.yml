name: CD Pipeline - Deploy FastAPI Todo App

on:
  workflow_run:
    workflows: ["CI Pipeline - Build & Push Docker Image"]
    types:
      - completed


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and deploy latest container
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üßπ Cleaning old containers..."
            CONTAINER_ID=$(sudo docker ps -q --filter "publish=8000")
            if [ -n "$CONTAINER_ID" ]; then
              echo "Stopping old container on port 8000..."
              sudo docker stop $CONTAINER_ID || true
              sudo docker rm $CONTAINER_ID || true
            fi

            echo "üì¶ Pulling latest image..."
            sudo docker pull akashdocker134/todo-fastapi:latest

            echo "üöÄ Starting new container..."
            sudo docker run -d -p 8000:8000 --name todo-fastapi akashdocker134/todo-fastapi:latest

            echo "üîç Verifying container is running..."
            sleep 5
            if sudo docker ps | grep -q "todo-fastapi"; then
              echo "‚úÖ Deployment verified successfully!"
            else
              echo "‚ùå Deployment failed ‚Äî container not running!"
              exit 1
            fi

